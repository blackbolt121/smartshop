<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="es">
<head>
    <meta charset="UTF-8">
    <title>Dashboard de Administración</title>
    <link rel="icon" type="image/x-icon" href="https://res.cloudinary.com/dv0hzntey/image/upload/v1754238574/urrea_g4nc5s.ico">
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Se añade la librería D3.js -->
    <script src="https://d3js.org/d3.v7.min.js"></script>
</head>
<body class="flex min-h-screen bg-gray-50">

<!-- ========== SECCIÓN DEL SIDEBAR (Se mantiene consistente) ========== -->
<div class="w-64 bg-white border-r border-gray-200 shadow-lg">
    <div class="p-4 text-xl font-bold border-b">
        <a th:href="@{/admin/dashboard}">
            <img th:src="@{/images/logo.png}" alt="SmartShop" class="w-40" />
        </a>
    </div>
    <nav class="p-4 space-y-2">
        <a th:href="@{/admin/users}" class="block px-4 py-2 rounded hover:bg-gray-100 text-gray-700">Usuarios</a>
        <a th:href="@{/admin/orders}" class="block px-4 py-2 rounded hover:bg-gray-100 text-gray-700">Pedidos</a>
        <a th:href="@{/admin/quotes}" class="block px-4 py-2 rounded hover:bg-gray-100 text-gray-700">Cotizaciones</a>
        <a th:href="@{/admin/products}" class="block px-4 py-2 rounded hover:bg-gray-100 text-gray-700">Productos</a>
        <a th:href="@{/admin/promotions}" class="block px-4 py-2 rounded hover:bg-gray-100 text-gray-700">Carousel</a>
        <a th:href="@{/admin/logout}" class="block px-4 py-2 rounded hover:bg-red-100 text-red-600">Cerrar sesión</a>
    </nav>
</div>

<!-- ========== CONTENIDO PRINCIPAL DEL NUEVO DASHBOARD ========== -->
<div class="flex-1 p-10">
    <h1 class="text-3xl font-bold text-gray-800 mb-8">Dashboard de Administración</h1>

    <!-- ===== Tarjetas de Resumen (KPIs) Interactivas ===== -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">

        <!-- Tarjeta: Total de Usuarios (Ahora es un enlace) -->
        <a th:href="@{/admin/users}" class="bg-white p-6 rounded-lg shadow border border-gray-200 flex items-center justify-between hover:shadow-lg hover:border-blue-400 transition-all">
            <div>
                <p class="text-sm font-medium text-gray-500 uppercase">Total de Usuarios</p>
                <p class="text-3xl font-bold text-gray-800" th:text="${totalUsuarios}">1,250</p>
            </div>
            <div class="bg-blue-100 p-3 rounded-full">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-blue-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" /></svg>
            </div>
        </a>

        <!-- Tarjeta: Total de Productos (Ahora es un enlace) -->
        <a th:href="@{/admin/products}" class="bg-white p-6 rounded-lg shadow border border-gray-200 flex items-center justify-between hover:shadow-lg hover:border-green-400 transition-all">
            <div>
                <p class="text-sm font-medium text-gray-500 uppercase">Total de Productos</p>
                <p class="text-3xl font-bold text-gray-800" th:text="${totalProductos}">16,842</p>
            </div>
            <div class="bg-green-100 p-3 rounded-full">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-green-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 8h14M5 8a2 2 0 110-4h14a2 2 0 110 4M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8m-9 4h4" /></svg>
            </div>
        </a>

        <!-- Tarjeta: Ingresos del Mes -->
        <div class="bg-white p-6 rounded-lg shadow border border-gray-200 flex items-center justify-between">
            <div>
                <p class="text-sm font-medium text-gray-500 uppercase">Ingresos del Mes</p>
                <p class="text-3xl font-bold text-gray-800" th:text="'$' + ${#numbers.formatDecimal(ingresosMes, 1, 'COMMA', 2, 'POINT')}">$45,320.50</p>
            </div>
            <div class="bg-yellow-100 p-3 rounded-full">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-yellow-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v.01M12 14v1m0-6v.01M12 12a2 2 0 002-2m-2 2a2 2 0 01-2-2" /></svg>
            </div>
        </div>

        <!-- Tarjeta: Pedidos Nuevos (Ahora es un enlace) -->
        <a th:href="@{/admin/orders}" class="bg-white p-6 rounded-lg shadow border border-gray-200 flex items-center justify-between hover:shadow-lg hover:border-purple-400 transition-all">
            <div>
                <p class="text-sm font-medium text-gray-500 uppercase">Pedidos Nuevos</p>
                <p class="text-3xl font-bold text-gray-800" th:text="${pedidosNuevos}">38</p>
            </div>
            <div class="bg-purple-100 p-3 rounded-full">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-purple-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01" /></svg>
            </div>
        </a>
    </div>

    <!-- ===== Sección de Gráficos ===== -->
    <div class="grid grid-cols-1 lg:grid-cols-5 gap-6 mb-8">
        <div class="lg:col-span-3 bg-white p-6 rounded-lg shadow border border-gray-200">
            <h2 class="text-lg font-semibold text-gray-800 mb-4">Ingresos por Mes</h2>
            <div id="bar-chart-container"></div>
        </div>
        <div class="lg:col-span-2 bg-white p-6 rounded-lg shadow border border-gray-200">
            <h2 class="text-lg font-semibold text-gray-800 mb-4">Productos por Marca</h2>
            <div id="donut-chart-container"></div>
        </div>
    </div>

    <!-- ===== Sección de Actividad Reciente ===== -->
    <div class="grid grid-cols-1">
        <div class="bg-white p-6 rounded-lg shadow border border-gray-200">
            <h2 class="text-lg font-semibold text-gray-800 mb-4">Últimos Pedidos</h2>
            <div class="overflow-x-auto">
                <table class="min-w-full text-sm">
                    <thead class="text-left text-gray-500">
                    <tr>
                        <th class="p-2">ID Pedido</th>
                        <th class="p-2">Cliente</th>
                        <th class="p-2">Monto</th>
                        <th class="p-2">Estado</th>
                    </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-100">
                    <tr th:each="pedido : ${ultimosPedidos}">
                        <td class="p-2 font-mono text-gray-600" th:text="${'#' + pedido.id}">#87654</td>
                        <td class="p-2 font-medium text-gray-800" th:text="${pedido.usuario.name}">Ana Torres</td>
                        <td class="p-2 text-gray-700" th:text="'$' + ${#numbers.formatDecimal(pedido.total, 1, 'COMMA', 2, 'POINT')}">$599.00</td>
                        <td class="p-2">
                                <span class="px-2 py-1 text-xs font-semibold rounded-full"
                                      th:text="${pedido.pedidoStatus.status}"
                                      th:classappend="${pedido.pedidoStatus.name() == 'ENTREGADO'} ? 'bg-green-100 text-green-800' :
                                                     (${pedido.pedidoStatus.name() == 'ENVIADO'} ? 'bg-blue-100 text-blue-800' :
                                                     (${pedido.pedidoStatus.name() == 'CANCELADO'} ? 'bg-red-100 text-red-800' : 'bg-yellow-100 text-yellow-800'))">
                                    En proceso
                                </span>
                        </td>
                    </tr>
                    <tr th:if="${#lists.isEmpty(ultimosPedidos)}">
                        <td colspan="4" class="p-4 text-center text-gray-500">No hay pedidos recientes.</td>
                    </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Script para los gráficos D3.js -->
<script th:inline="javascript">
    /*<![CDATA[*/

    // --- DATOS PARA LOS GRÁFICOS (DEBEN VENIR DEL CONTROLADOR) ---
    const salesDataRaw = /*[[${salesDataJson}]]*/ [{"year":2025,"month":7,"totalSales":209190.56}];
    const categoryData = /*[[${categoryDataJson}]]*/ [{"category":"Ferretería","count":450}];
    console.log(categoryData)


    // --- LÓGICA PARA RENDERIZAR LOS GRÁFICOS ---
    document.addEventListener('DOMContentLoaded', function() {

        // --- PROCESAMIENTO DE DATOS PARA EL GRÁFICO DE BARRAS ---
        // Se procesan los datos aquí en el frontend para que coincidan con el formato esperado.
        const monthNames = ["Ene", "Feb", "Mar", "Abr", "May", "Jun", "Jul", "Ago", "Sep", "Oct", "Nov", "Dic"];
        const salesData = (salesDataRaw).map(d => ({
            month: monthNames[d.month - 1], // Convierte el número de mes (1-12) a nombre ("Ene", "Feb", etc.)
            sales: d.totalSales // Usa la clave correcta 'totalSales'
        }));

        const tooltip = d3.select("body").append("div")
            .attr("class", "d3-tooltip absolute z-10 p-2 text-xs bg-gray-800 text-white rounded-md shadow-lg pointer-events-none")
            .style("opacity", 0);

        function drawBarChart() {
            if (!salesData || salesData.length === 0) return;
            const container = d3.select("#bar-chart-container");
            container.select("svg").remove(); // Limpiar gráfico anterior

            const width = container.node().getBoundingClientRect().width;
            const height = 300;
            const margin = { top: 20, right: 20, bottom: 30, left: 50 };

            const svg = container.append("svg")
                .attr("width", width)
                .attr("height", height);

            const x = d3.scaleBand()
                .domain(salesData.map(d => d.month))
                .range([margin.left, width - margin.right])
                .padding(0.2);

            const y = d3.scaleLinear()
                .domain([0, d3.max(salesData, d => d.sales)]).nice()
                .range([height - margin.bottom, margin.top]);

            svg.append("g")
                .attr("transform", `translate(0,${height - margin.bottom})`)
                .call(d3.axisBottom(x));

            svg.append("g")
                .attr("transform", `translate(${margin.left},0)`)
                .call(d3.axisLeft(y).ticks(5).tickFormat(d => `$${d/1000}k`));

            svg.append("g")
                .selectAll("rect")
                .data(salesData)
                .join("rect")
                .attr("x", d => x(d.month))
                .attr("y", d => y(d.sales))
                .attr("height", d => y(0) - y(d.sales))
                .attr("width", x.bandwidth())
                .attr("fill", "#4f46e5")
                .on("mouseover", (event, d) => {
                    tooltip.transition().duration(200).style("opacity", .9);
                    tooltip.html(`Ventas: $${d.sales.toLocaleString()}`)
                        .style("left", (event.pageX + 5) + "px")
                        .style("top", (event.pageY - 28) + "px");
                })
                .on("mouseout", () => {
                    tooltip.transition().duration(500).style("opacity", 0);
                });
        }

        function drawDonutChart() {
            if (!categoryData || categoryData.length === 0) return;
            const container = d3.select("#donut-chart-container");
            container.select("svg").remove();

            const width = container.node().getBoundingClientRect().width;
            const height = 300;
            const radius = Math.min(width, height) / 2 - 20;

            const svg = container.append("svg")
                .attr("width", width)
                .attr("height", height)
                .append("g")
                .attr("transform", `translate(${width / 2},${height / 2})`);

            const color = d3.scaleOrdinal(d3.schemeTableau10);

            const pie = d3.pie().value(d => d.count).sort(null);
            const data_ready = pie(categoryData);

            const arc = d3.arc().innerRadius(radius * 0.6).outerRadius(radius * 0.9);

            svg.selectAll('path')
                .data(data_ready)
                .join('path')
                .attr('d', arc)
                .attr('fill', d => color(d.data.category))
                .attr("stroke", "white")
                .style("stroke-width", "2px")
                .on("mouseover", (event, d) => {
                    tooltip.transition().duration(200).style("opacity", .9);
                    tooltip.html(`<b>${d.data.category}</b>: ${d.data.count} productos`)
                        .style("left", (event.pageX + 5) + "px")
                        .style("top", (event.pageY - 28) + "px");
                })
                .on("mouseout", () => {
                    tooltip.transition().duration(500).style("opacity", 0);
                });
        }

        drawBarChart();
        drawDonutChart();

        window.addEventListener('resize', () => {
            drawBarChart();
            drawDonutChart();
        });
    });
    /*]]>*/
</script>

</body>
</html>
